<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PrettyData — Decor Signals</title>

  <!-- Chart.js + date adapter + Papa Parse for CSVs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --ink:#111827; --muted:#6b7280; --line:#e5e7eb; --card:#ffffff; --bg:#f9fafb; --brand:#111827;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    header{padding:28px 24px;border-bottom:1px solid var(--line);background:#fff;position:sticky;top:0;z-index:2}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    h1{font-size:28px;margin:0}
    .subtitle{color:var(--muted);font-size:14px;margin-top:6px}

    .grid{display:grid;gap:20px;grid-template-columns:1fr}
    @media(min-width:900px){ .grid{grid-template-columns:1fr 1fr} }

    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:18px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .card h2{margin:0 0 10px;font-size:18px}
    .small{font-size:12px;color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;font-size:12px;background:#fff}
    a.download{font-size:12px;color:#2563eb;text-decoration:none}
    a.download:hover{text-decoration:underline}

    .kpis{display:grid;gap:14px;grid-template-columns:repeat(3,1fr);margin-bottom:18px}
    .kpi{background:#fff;border:1px solid var(--line);border-radius:12px;padding:14px}
    .kpi .label{color:var(--muted);font-size:12px}
    .kpi .value{font-size:22px;font-weight:700}

    footer{padding:24px;color:var(--muted);text-align:center}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>PrettyData — Decor Signals</h1>
      <div class="subtitle">Auto-refreshed from Reddit every ~15 minutes (HomeDecorating · InteriorDesign · CozyPlaces)</div>
    </div>
  </header>

  <main class="wrap">
    <div class="kpis">
      <div class="kpi"><div class="label">Posts + comments analyzed (7d)</div><div id="kpi-rows" class="value">–</div></div>
      <div class="kpi"><div class="label">Tracked phrases</div><div id="kpi-terms" class="value">–</div></div>
      <div class="kpi"><div class="label">Last updated (UTC)</div><div id="kpi-updated" class="value">–</div></div>
    </div>

    <div class="grid">
      <section class="card">
        <h2>Top Risers</h2>
        <div class="row">
          <span class="small">Slope of weekly mentions · positive & p&lt;.05</span>
          <a class="download" id="dl-inc" target="_blank">Download CSV</a>
        </div>
        <canvas id="chart-inc" height="260"></canvas>
      </section>

      <section class="card">
        <h2>Top Fallers</h2>
        <div class="row">
          <span class="small">Slope of weekly mentions · negative & p&lt;.05</span>
          <a class="download" id="dl-dec" target="_blank">Download CSV</a>
        </div>
        <canvas id="chart-dec" height="260"></canvas>
      </section>
    </div>

    <section class="card" style="margin-top:20px">
      <div class="row" style="justify-content:space-between">
        <h2>Mentions Over Time</h2>
        <div class="row">
          <label class="small">Show:</label>
          <select id="series-select" class="pill" multiple size="4" title="Choose terms">
            <!-- filled in JS -->
          </select>
          <span class="small">Tip: Cmd/Ctrl+click to select multiple</span>
        </div>
      </div>
      <canvas id="chart-ts" height="320"></canvas>
      <div class="row" style="margin-top:8px">
        <a class="download" id="dl-ts" target="_blank">Download CSV</a>
      </div>
    </section>

    <section class="card" style="margin-top:20px">
      <h2>Top Bigrams (phrases)</h2>
      <div class="row"><a class="download" id="dl-bigrams" target="_blank">Download CSV</a></div>
      <div id="bigrams-list" class="small"></div>
    </section>
  </main>

  <footer>© Pretty Little Data — decor demo. Extend to fashion/beauty by adding more scrape/analyze steps.</footer>

  <script>
    // ---- CONFIG (these point at your repo's raw CSVs) ----
    const RAW = "https://raw.githubusercontent.com/prettylittledata/prettylittledata/main/data/";
    const FILES = {
      inc:   "decor_increasing_terms.csv",
      dec:   "decor_decreasing_terms.csv",
      ts:    "decor_term_counts_over_time.csv",
      bigr:  "decor_top_bigrams.csv",
      raw:   "decor_reddit_raw.csv"
    };

    // ---- UTILITIES ----
    async function fetchCSV(name){
      const url = RAW + name + "?t=" + Date.now(); // cache-bust
      const txt = await fetch(url).then(r => r.text());
      const parsed = Papa.parse(txt.trim(), { header:true, skipEmptyLines:true });
      return parsed.data;
    }
    function formatUTC(d){ return new Date(d).toISOString().replace('T',' ').replace('Z',''); }

    // ---- KPI + LINKS ----
    function setLinks(){
      document.getElementById('dl-inc').href  = RAW + FILES.inc;
      document.getElementById('dl-dec').href  = RAW + FILES.dec;
      document.getElementById('dl-ts').href   = RAW + FILES.ts;
      document.getElementById('dl-bigrams').href = RAW + FILES.bigr;
    }

    // ---- CHARTS ----
    let incChart, decChart, tsChart;

    function drawBars(canvasId, labels, values, label){
      const ctx = document.getElementById(canvasId);
      return new Chart(ctx, {
        type: "bar",
        data: { labels, datasets: [{ label, data: values }] },
        options: {
          plugins: { legend: { display:false }, tooltip: { callbacks: { label: c => `${c.raw.toFixed ? c.raw.toFixed(3) : c.raw}` } } },
          scales: { x: { ticks: { autoSkip:false } } }
        }
      });
    }

    function drawLines(datasets){
      const ctx = document.getElementById("chart-ts");
      return new Chart(ctx, {
        type: "line",
        data: { datasets },
        options: {
          parsing: false,
          interaction: { mode:'nearest', intersect:false },
          plugins: { legend: { position: 'bottom' } },
          scales: {
            x: { type:'time', time:{ unit:'week' } },
            y: { beginAtZero:true }
          }
        }
      });
    }

    async function init(){
      setLinks();

      const [inc, dec, ts, bigr, raw] = await Promise.all([
        fetchCSV(FILES.inc),
        fetchCSV(FILES.dec),
        fetchCSV(FILES.ts),
        fetchCSV(FILES.bigr),
        fetchCSV(FILES.raw)
      ]);

      // KPIs
      document.getElementById("kpi-rows").textContent   = raw.length.toLocaleString();
      document.getElementById("kpi-terms").textContent  = new Set(ts.map(r=>r.Term)).size;
      const latest = ts.reduce((m,r)=>!m||r.period>m? r.period : m, null);
      document.getElementById("kpi-updated").textContent = latest ? formatUTC(latest) : "–";

      // Bars
      incChart = drawBars("chart-inc", inc.map(d=>d.Term), inc.map(d=>+d.estimate), "Slope (↑ rising)");
      decChart = drawBars("chart-dec", dec.map(d=>d.Term), dec.map(d=>+d.estimate), "Slope (↓ falling)");

      // Time series: options
      const byTerm = {};
      ts.forEach(r => {
        const t = r.Term;
        (byTerm[t] ||= []).push({ x: r.period, y: +r.Count });
      });
      // sort by time inside each series
      Object.values(byTerm).forEach(arr => arr.sort((a,b)=> new Date(a.x) - new Date(b.x)));

      const termList = Object.keys(byTerm).sort();
      const select = document.getElementById("series-select");
      termList.slice(0,8).forEach((t,i)=>{
        const opt = document.createElement("option");
        opt.value = t; opt.textContent = t; opt.selected = i < 6;
        select.appendChild(opt);
      });

      function selectedTerms(){
        return [...select.options].filter(o=>o.selected).map(o=>o.value);
      }

      function makeDatasets(names){
        return names.map(name => ({
          label: name,
          data: byTerm[name] || []
        }));
      }

      tsChart = drawLines(makeDatasets(selectedTerms()));
      select.addEventListener("change", ()=>{
        tsChart.data.datasets = makeDatasets(selectedTerms());
        tsChart.update();
      });

      // Bigrams list (top 25)
      const top = bigr.slice(0,25);
      document.getElementById("bigrams-list").innerHTML =
        top.map(r => `<span class="pill">${r.bigram} — ${r.count}</span>`).join(" ");
    }

    init();
  </script>
</body>
</html>
